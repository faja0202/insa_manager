{# templates/main.html
   - 대시보드 위젯 구성
   - 최근 변경 사항: change_log.jsonl 기반 상세 필드 변경 내역 표시
   - DB 현황 요약: 직원 수 / 최종 수정자 / 최종 수정시각
   - 반응형 그리드 단순화(.span-6 유틸)
#}
{% extends 'base.html' %}
{% block title %}대시보드{% endblock %}

{% block content %}
  <!-- 헤더/히어로 -->
  <section class="card" aria-label="대시보드 인사말">
    <div class="card-header">대시보드</div>
    <div class="card-body">
      <p style="margin-bottom:.75rem; color:var(--color-grey);">
        안녕하세요{% if current_user and current_user.is_authenticated %}, <strong>{{ current_user.username }}</strong>님{% endif %}. 오늘도 좋은 하루 되세요!
      </p>
      <div style="display:flex; gap:.5rem; flex-wrap:wrap;">
        <a class="btn" href="{{ url_for('employee_list') }}">직원 목록</a>
        <a class="btn secondary" href="{{ url_for('ip_block') }}">IP 차단 테스트</a>
      </div>
    </div>
  </section>

  <!-- 대시보드 그리드 -->
  <section class="dashboard-grid" aria-label="주요 위젯">
    <!-- 1) (자리 보존) 면담 기록 -->
    <div class="card span-6">
      <div class="card-header">면담 기록</div>
      <div class="card-body">
        <p style="color:var(--color-grey); margin-bottom:.75rem;">면담기록 관련 기능은 업데이트 예정입니다.</p>
      </div>
    </div>

    <!-- 2) 최근 변경 사항 -->
    <div class="card span-6">
      <div class="card-header">최근 변경 사항</div>
      <div class="card-body">
        {% if recent_changes and recent_changes|length > 0 %}
          <ul style="list-style:none; padding-left:0; margin:0;">
            {% for item in recent_changes %}
              <li style="margin: .5rem 0; padding:.5rem .75rem; background:#fff; border:1px solid var(--color-border); border-radius:6px;">
                <div style="font-weight:600;">
                  {{ item.employee }} <span style="color:var(--color-grey); font-weight:400;">— {{ item.owner }} · {{ item.updated_at }}</span>
                </div>
                {% if item.changes and item.changes|length > 0 %}
                  <details style="margin-top:.35rem;">
                    <summary style="cursor:pointer; color:var(--color-primary);">필드 변경 보기</summary>
                    <ul style="margin-top:.35rem; padding-left:1rem;">
                      {% for c in item.changes %}
                        <li><code>{{ c.field }}</code>: <span style="color:#b00;">{{ c.old or '∅' }}</span> → <span style="color:#070;">{{ c.new or '∅' }}</span></li>
                      {% endfor %}
                    </ul>
                  </details>
                {% else %}
                  <div style="color:var(--color-grey); font-size:.9rem;">(필드 변경 없음)</div>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p style="color:var(--color-grey);">최근 변경 이력이 없습니다.</p>
        {% endif %}
      </div>
    </div>

    <!-- 3) 직원 빠른 검색 -->
    <div class="card span-6">
      <div class="card-header">직원 빠른 검색</div>
      <div class="card-body">
        <div style="display:flex; gap:.5rem;">
          <input id="quick-search" type="text" placeholder="이름/내선/MBTI 키워드" style="flex:1;">
          <button class="btn" type="button" onclick="goEmployeeList()">검색</button>
        </div>
        <p style="margin-top:.5rem; color:var(--color-grey); font-size:.9rem;">
          우측 상단 검색창도 활용 가능합니다.
        </p>
      </div>
    </div>

    <!-- 4) DB 현황 요약 -->
    <div class="card span-6">
      <div class="card-header">DB 현황 요약</div>
      <div class="card-body">
        <ul>
          <li>최종 수정일시: <strong>{{ db_last_modified or '-' }}</strong></li>
          <li>전체 직원 수: <strong>{{ employee_count or '-' }}</strong></li>
          <li>최종 수정자: <strong>{{ db_last_modifier or '-' }}</strong></li>
        </ul>
      </div>
    </div>
  </section>

  <style>
    /* 대시보드 그리드 유틸: 간단/견고하게 */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 1rem;
    }
    .dashboard-grid .span-12 { grid-column: span 12; }
    .dashboard-grid .span-6  { grid-column: span 6; }
    .dashboard-grid .span-4  { grid-column: span 4; }
    @media (max-width: 992px) { .dashboard-grid .span-6, .dashboard-grid .span-4 { grid-column: span 12; } }

    /* summary 토글 포커스 스타일(접근성) */
    details > summary:focus { outline: 2px solid var(--color-primary); outline-offset: 2px; }
    code { background: #f6f8fa; padding: 0 .3rem; border-radius: 3px; }
  </style>

  <script>
    function goEmployeeList(){
      var q = document.getElementById('quick-search').value.trim();
      if(!q){ window.location.href = "{{ url_for('employee_list') }}"; return; }
      var url = new URL("{{ url_for('employee_list') }}", window.location.origin);
      url.searchParams.set('q', q);
      window.location.href = url.toString();
    }
  </script>
{% endblock %}
